<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport"
		content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<meta http-equiv="Expires" content="0">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Cache-control" content="no-cache">
	<meta http-equiv="Cache" content="no-cache">
	<title>提交</title>
	<link rel="stylesheet" type="text/css" href="css/common.css">
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/jquery-ui.js"></script>
	<script type="text/javascript">
	jQuery.browser={};(function(){jQuery.browser.msie=false; jQuery.browser.version=0;if(navigator.userAgent.match(/MSIE ([0-9]+)./)){ jQuery.browser.msie=true;jQuery.browser.version=RegExp.$1;}})();
	</script>
	<script type="text/javascript" src="js/jquery.alerts.js"></script>
	<link href="css/mui.min.css" rel="stylesheet" />
	<link href="css/jquery.alerts.css" rel="stylesheet" />
	<style type="text/css">
		.toggle dl{margin: 0;}
		.toggle dl dt { background:#F4FFF4 url('/jscss/demoimg/201102/bg_toggle_up.gif') no-repeat scroll 8px 14px; height:40px; line-height:40px; font-weight:bold; color:#006600; cursor:pointer;  padding-left:25px; display:block; }
		.toggle dl dt.current { background:#F4FFF4 url('/jscss/demoimg/201102/bg_toggle_down.gif') no-repeat scroll 8px 14px; }
		.news {
			margin: 10px; 
			text-align: center;
		}
		#tab {
			width: 100%; 
			border: solid 1px #DEDEE3; 
		}
		#tab tr {
			background-color: #A1A2A4;
		}
		.cbox {
			padding: 5px 0 0 15px;
		    color: #007AFF;
		}
	</style>
</head>
<body>
	<header>
		<h3 style="padding: 13px;">增值税电子普通发票</h3>
	</header>

	<section>
		<form class="mui-input-group" action="tijiao/fpxx" method="post">
			<div class="cbox">
				<input type="checkbox" id="choose" name="" checked onclick="CheckAll(this);">
				<label for="choose">用于报销</label>
			</div>
			<div class="mui-input-row">
				<label><font color="red">*</font>发票抬头</label> 
				<input type="text" class="mui-input-clear" required="required" maxlength="50"
					name="fptt" id="fptt" placeholder="请输入发票抬头">
			</div>
			<div class="mui-input-row">
				<label><font color="red" class="isCheck">*</font>购方税号</label> 
				<input type="text" class="mui-input-clear" id="nsrsbh" maxlength="20"
					name="nsrsbh" placeholder="请输入购方税号">
			</div>

			<ul class="mui-table-view">
				<div class="content">
		          	<div class="toggle">
				    	<dl>
			              	<dt>点击填写更多购方信息</dt>
			              	<dd>
			        			<div class="mui-collapse-content">
									
									<div class="mui-input-row">
										<label>地址</label> <input type="text" class="mui-input-clear" id="dz"
											maxlength="100" name="dz" placeholder="请输入地址">
									</div>
									<div class="mui-input-row">
										<label>电话</label> <input type="text" class="mui-input-clear" id="dh"
											maxlength="30" name="dh" placeholder="请输入电话">
									</div>
									<div class="mui-input-row">
										<label>开户行</label> <input type="text" class="mui-input-clear"
											id="khh" maxlength="50" name="khh" placeholder="请输入开户行">
									</div>
									<div class="mui-input-row">
										<label>银行账号</label> <input type="text" class="mui-input-clear"
											id="yhzh" maxlength="50" name="yhzh" placeholder="请输入银行账号">
									</div>
								</div>
				      		</dd>
			            </dl>
				  	</div>
			 	</div>
				<div class="mui-input-row">
					<label><font color="red">*</font>邮箱地址</label>
					<input type="email" id="yx" class="mui-input-clear" placeholder="接收电子发票的邮箱">
				</div>
			</ul>
		</form>
	</section>
		
	<section class="news">
		<table border="1" id="tab">
			<tr>
				<td>消费内容</td>
				<td>可开票金额</td>
				<td>税率</td>
			</tr>
		</table>
	</section>

	<button id='confirmBtn' type="button" onclick="tk()" class="mui-btn mui-btn-primary mui-btn-block ">
		确 认
	</button>

	<div id="info" style="margin-bottom: 80px; color: red; margin-left: 2%;"></div>

	<footer>
		<p class="company">上海容津信息技术有限公司</p>
		<p class="help"><a href="bangzhu.html">遇到问题?</a></p>
	</footer>

	<script type="text/javascript" charset="utf-8">
		var djh;
		var storage=window.localStorage;
		$(function() {
			$(".toggle dl dd").hide();
			$(".toggle dl dt").click(function(){
				$(".toggle dl dd").not($(this).next()).hide();
				$(".toggle dl dt").not($(this).next()).removeClass("current");
				$(this).next().slideToggle(500);
				$(this).toggleClass("current");
				});

			$.post(
				"tijiao/tjsession", 
				{}, 
				function(data) {
					djh = data.tqm;
					var slv = data.slv;
					slv = parseFloat(slv) * 100;
					if (djh != null && djh != "") {
						$("#tab").append("<tr><td>餐饮服务</td><td>" + data.zje + "</td><td>"+slv+"%</td></tr>")
					} else {
						window.location.href = "smtq/demo.html?time=" + new Date();
					}
				}
			);
		  	$.post(
                '/getInvoiceTitle',
                {},
                function(test) {
					if(test.success) {
					    var dataList = test.data;
					    for(var i=0;i<dataList;i++) {
                            if(dataList[i].isDefault) {
                            	
                            }else {
                            	
                            }
						}

					}
                }
            );


		});

		function tiaozhuan() {
			window.location.href = "bangzhu.html?time=" + new Date();
		}
		var json=storage.getItem("data");
		//转之前判断是不是标准的字符串格式,不是的话需要转换
		var obj = JSON.parse('['+json+']');
		for(var i=0;i<obj.length;i++) {
			if(obj[i].fptt != '') {
				document.getElementById('fptt').value = obj[i].fptt;
			}
			if(obj[i].nsrsbh != '') {
				document.getElementById('nsrsbh').value = obj[i].nsrsbh;
			}
			if(obj[i].dz != '') {
				document.getElementById('dz').value = obj[i].dz;
			}
			if(obj[i].dh != '') {
				document.getElementById('dh').value = obj[i].dh;
			}
			if(obj[i].khh != '') {
				document.getElementById('khh').value = obj[i].khh;
			}
			if(obj[i].yhzh != '') {
				document.getElementById('yhzh').value = obj[i].yhzh;
			}
			if(obj[i].yx != '') {
				document.getElementById('yx').value = obj[i].yx;
			}
		};
		function tk() {
			var info = document.getElementById("info");
			var filter  = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
			var fptt = $('#fptt').val();
			var yx = $('#yx').val();
			var nsrsbh = $('#nsrsbh').val();
			var firm;
			var title;
			if (null == fptt || "" == fptt) {
				var btnArray = [ '是' ];
				firm = "请输入发票抬头!";
				title = "提示";
				alert(firm, title);
				return;
			}else if (null == yx || "" == yx) {
				var btnArray = [ '是' ];
				firm = "请输入邮箱!";
				title = "提示";
				alert(firm, title);
				return;
			}else if ( (null==nsrsbh || nsrsbh=='') && ($('#choose').prop("checked")) ) {
				var btnArray = [ '是' ];
				firm = "请输购方税号!";
				title = "提示";
				alert(firm, title);
				return;
			}else if(!filter.test(yx)){
				 var btnArray = [ '是' ];
					firm = "邮箱格式不正确!";
					title = "提示";
					alert(firm, title);
					return;
			} else {
				firm = "发票抬头:" + fptt + "</br>";
				var nsrsbh = $('#nsrsbh').val();
				var dz = $('#dz').val();
				var dh = $('#dh').val();
				var khh = $('#khh').val();
				var yhzh = $('#yhzh').val();
				if(null!=nsrsbh&&nsrsbh!=''){
					if(nsrsbh.length!=15&&nsrsbh.length!=18&&nsrsbh.length!=20){
						firm = "税号长度不对,税号为15,18,20位中一种";
						title = "提示";
						alert(firm, title);
						return;
					}
				}

				// 本地缓存
				if(!window.localStorage){
		            return false;
		        }else{
		            
		            var data={
		                fptt: fptt,
		                nsrsbh: nsrsbh,
		                dz: dz,
		                dh: dh,
		                khh: khh,
		                yhzh: yhzh,
		                yx: yx
		            };
		            var d=JSON.stringify(data);
		            storage.setItem("data",d);
		        }
			//	var sjh = $('#sjh').val();
				var btnArray = [ '否', '是' ];
				if (null != nsrsbh && "" != nsrsbh) {
					firm += "购方税号:" + nsrsbh + "</br>";
				}
				if (null != dz && "" != dz) {
					firm += "地址:" + dz +  "</br>";
				}
				if (null != dh && "" != dh) {
					firm += "电话:" + dh +  "</br>";
				}
				if (null != khh && "" != khh) {
					firm += "开户行:" + khh +  "</br>";
				}
				if (null != yhzh && "" != yhzh) {
					firm += "银行账号:" + yhzh +  "</br>";
				}
				if (null != yx && "" != yx) {
					firm += "邮箱:" + yx +  "</br>";
				}
			/* 	if (null != sjh && "" != sjh) {
					firm += "手机:" + sjh + "。";
				} */
				title = "信息确认";
				$("#confirmBtn").attr("disabled",true);
				jConfirm(firm,title, function(r) {
					if(r){
						$.post("dzfp_sqj/saveLs", {
							"fptt" : fptt,
							"nsrsbh" : nsrsbh,
							"dz" : dz,
							"dh" : dh,
							"khh" : khh,
							"khhzh" : yhzh,
							"yx" :yx
							//"sj" : sj
						}, function(data) {
							if (data.msg == 1) {
								info.innerText = '已收到您的开票申请,发票开具完成后会发送到预留邮箱,请关注邮箱或稍候再次提取!';
								//fpzt();
								window.location.href = "smtq/smtq3.html?time=" + new Date();
							} else {
								btnArray = [ '确定' ];
								firm = data.msg;
								info.innerText =firm;
								$("#confirmBtn").attr("disabled",false);
							}
						});
					}else{
						info.innerText = '请重新确认';
						$("#confirmBtn").attr("disabled",false);
					}
				});
			}
		}

		function CheckAll(obj) {
		   if ($(obj).prop("checked")) {
		      $('.isCheck').html('*');
		   } else {
		      $('.isCheck').html('');
		   }
		} 	
	</script>
</body>
</html>