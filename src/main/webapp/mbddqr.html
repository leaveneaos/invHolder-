<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>订单确认</title>
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<link rel="stylesheet" type="text/css" href="css/common.css">
	<!--<link rel="stylesheet" type="text/css" href="css/ddqr.css">-->
</head>
<body>
	<header>
		<img id="logo" src="images/rjxx.jpg"/>
	</header>
	<section class="main">
		<div class="shadow1"></div>
		<div class="shadow2"></div>
		<div class="content">
			<div class="middle" >
		         <ul>
		            <li class="fl">订单编号 :</li>
		            <li class="fr omit" id="order"></li>
		        </ul>
		        <ul>
		            <li class="fl">交易日期 :</li>
		            <li class="fr omit" id="orderTime"></li>
		        </ul>
		        <ul>
		            <li class="fl">合计金额 :</li>
		            <li class="fr omit" id="price" ></li>
		        </ul>
			</div>
			<div class="bottom" style="margin-left: 10%">
				<input type="hidden" id="tqmhidden">
				<button id="sure" type="submit" onclick="sure()">确&nbsp;&nbsp;&nbsp;&nbsp;认</button>
			</div>
		</div>
	</section>
	<footer>
		<p class="company fl">泰易电子发票云服务平台</p>
		<p class="help fr"><a href="bangzhu.html">遇到问题?</a></p>
	</footer>

	<script src="js/jquery.min.js"></script>
	<script type="text/javascript">
		var msg=null;
        function redirect(errorMsg){
            var myurl = "QR/error.html?msg="+new Date+"="+errorMsg;
            window.location.assign(encodeURI(myurl));
        }
		$(function () {
            var thisURL = document.URL;
            var  getval =thisURL.split('?')[1];
            gsmc = null
            orderNo= null;
            price=null;
            orderTime=null;
			storeNo="";
            gsmc = getval.split("=")[2];
            orderNo = getval.split("=")[3];
            price = getval.split("=")[4];
            orderTime = getval.split("=")[5];
            xgsdm = getval.split("=")[6];
			$('#order').html(orderNo);
			$('#orderTime').html(formatDate(orderTime));
			$('#price').html(RetainedDecimalPlaces(price)+"元");
			$('#tqmhidden').html(orderNo);
			$("#logo").attr("src", "images/" + gsmc + ".png");
			if(xgsdm!=null && xgsdm!=""){
			    orderNo=xgsdm+"-"+orderNo;
			}
                //alert(orderNo);
            $.post(
                "qrxxsession",
                {},
                function (data) {
                    if(null!=data.error&&""!=data.error){
                        redirect(data.error);
                        $("#sure").attr("disabled","disabled");
                    }
                    if(null!=data.msg&&""!=data.msg){
                        redirect(data.msg);
                        $("#sure").attr("disabled","disabled");
                    }
                    if(data.num!=null && data.num==2){
                        //$('#orderTime').html(data.orderTime);
                        //orderTime=data.orderTime;
                        $("#sure").attr("disabled",false);
                    }
                }
            )
	    });

        function RetainedDecimalPlaces(num) {
            num = parseFloat(num).toFixed(2);
            var source = String(num).split(".");
            source[0] = source[0].replace(new RegExp('(\\d)(?=(\\d{3})+$)', 'ig'), "$1,");
            return source.join(".");
        };
        //格式化日期
        function formatDate(dateTime) {
            var YYYY = dateTime.substring(0,4);
            var MM = dateTime.substring(4,6);
            var dd = dateTime.substring(6,8);
            var HH = dateTime.substring(8,10);
            var ss = dateTime.substring(10,12);
            var mm = dateTime.substring(12,14);
            var date = YYYY+"-"+MM+"-"+dd+" "+HH+":"+ss+":"+mm;
            return date;
        };
        function sure() {
			var tqm=$('#tqmhidden').text();
            var ua = navigator.userAgent.toLowerCase();
            var isWeixin = ua.indexOf('micromessenger') != -1;
            var isAlipay = ua.indexOf('alipay') != -1;
            if(isAlipay){
                window.location.href = "mbfptt.html?gsdm="+gsmc+"&&tqm="+ tqm +"&&time=" + new Date();
            }else if(isWeixin){
                if(orderNo==null||orderTime==null||price==null){
                    redirect("获取商品信息有误,请重新扫码或联系商户！")
				}else {
                window.location = "common/isBrowser?orderNo=" + orderNo + "&orderTime=" + orderTime +
                    "&storeNo=" + storeNo + "&price=" + price;
                }
            }
            else {
                window.location.href = "mbfptt.html?gsdm="+ gsmc +"&&tqm="+ tqm +"&&time=" + new Date();
			}
        }
	</script>
</body>
</html>
