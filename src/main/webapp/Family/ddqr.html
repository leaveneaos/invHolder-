<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>订单确认</title>
	<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta http-equiv="Expires" content="0">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Cache-control" content="no-cache">
	<meta http-equiv="Cache" content="no-cache">
	<link rel="stylesheet" type="text/css" href="css/common.css">
	<link rel="stylesheet" type="text/css" href="css/ddqr.css">
</head>
<body>
	<header>
		<img src="../images/nav.png">
	</header>
	<section class="main">
		<div class="shadow1"></div>
		<div class="shadow2"></div>
		<div class="content">
			<div class="top">
				<span class="one">订单确认</span><span class="one">&gt;</span>
				<span>订单明细</span><span>&gt;</span>
				<span>发票抬头</span><span>&gt;</span>
				<span>发票保存</span>
			</div>
			<div class="middle" style="height: 240px;">
		        <ul>
		            <li class="fl">店铺名称 :</li>
		            <li class="fr omit" id="orderNo"></li>
		        </ul>
		         <ul>
		            <!--<li class="fl">序&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;号 :</li>-->
		            <li class="fl">交易序号 :</li>
		            <li class="fr omit" id="order"></li>
		        </ul>
		        <ul>
		            <li class="fl">交易日期 :</li>
		            <li class="fr omit" id="orderTime"></li>
		        </ul>
		        <ul>
		            <li class="fl">合计金额 :</li>
		            <li class="fr omit" id="price" ></li>
		        </ul>
			</div>
			<div class="bottom">
				<input type="hidden" id="tqmhidden">
				<button id="sure" type="submit" onclick="sure()">确&nbsp;&nbsp;&nbsp;&nbsp;认</button>
			</div>
		</div>
	</section>
	<footer>
		<p class="company fl">泰易电子发票云服务平台</p>
		<p class="help fr"><a href="../bangzhu.html">遇到问题?</a></p>
	</footer>

	<script src="../js/jquery.min.js"></script>
	<script src="../js/fpj.js"></script>
	<script type="text/javascript">
        function redirect(errorMsg){
            var myurl = "../QR/error.html?msg="+new Date+"="+errorMsg;
            window.location.assign(encodeURI(myurl));
        }
		$(function () {
            pricese=null;
            var thisURL = document.URL;
//            var thisURL = "/einv/Family/ddqr.html?_t=1511354036898=202481=72383060=6.0=20171122201221=112220248101723830607=";
            var  getval =thisURL.split('?')[1];
            orderNo= null;
            price=null;
            orderTime=null;
            storeNo=null;
            tqm=null;
            msg=null;
            storeNo = getval.split("=")[2];
            orderNo = getval.split("=")[3];
            price = getval.split("=")[4];
            orderTime = getval.split("=")[5];
            tqm = getval.split("=")[6];
            xgsdm = getval.split("=")[7];
			$('#orderNo').html(storeNo);
			$('#order').html(orderNo);
			$('#orderTime').html(formatDate(orderTime));
			$('#price').html(RetainedDecimalPlaces(price)+"元");
			pricese = price;
			if(xgsdm!=null && xgsdm!=""){
			    tqm=xgsdm+"-"+tqm
			}
            $('#tqmhidden').html(tqm);
            $.ajax({
                method : 'post',
                url:"../fm/qrxxsession",
                timeout : 5000,
				cache:false,
                data:{},
                dataType:"json",
                success: function (data) {
                    /*if(null!=data.error&&""!=data.error){
                        redirect(data.error);
                        $("#sure").attr("disabled","disabled");
                    }
                    if(null!=data.temp&&""!=data.temp){
                        redirect(data.temp);
                        $("#sure").attr("disabled","disabled");
                    }*/
                    if(data.status!=null && data.status=="2"){
                        //$('#orderNo').html(data.orderNo);
                        //$('#order').html(data.order);
                        //$('#orderTime').html(data.orderTime);
                        //$('#price').html(RetainedDecimalPlaces(data.price)+"元");
                        //pricese = data.price;
                        //$('#tqmhidden').html(data.tqm);
                        $("#sure").attr("disabled",false);
                    }
                },
                error:function(){
                    alert("Error");
				}
            });
//                $.post(
//                    "../fm/qrxxsession",
//                    {},
//                    function (data) {
//                        if(null!=data.error&&""!=data.error){
//                            redirect(data.error);
//                            $("#sure").attr("disabled","disabled");
//                        }
//                        if(null!=data.temp&&""!=data.temp){
//                            redirect(data.temp);
//                            $("#sure").attr("disabled","disabled");
//                        }
//						if(data.num!=null && data.num==2){
//                                $('#orderNo').html(data.orderNo);
//                                $('#order').html(data.order);
//                                $('#orderTime').html(data.orderTime);
//                                $('#price').html(RetainedDecimalPlaces(data.price)+"元");
//                                pricese = data.price;
//                                $('#tqmhidden').html(data.tqm);
//                                $("#sure").attr("disabled",false);
//						}
//                    }
//                )
	    });
		//格式化金额
        function RetainedDecimalPlaces(num) {
            num = parseFloat(num).toFixed(2);
            var source = String(num).split(".");
            source[0] = source[0].replace(new RegExp('(\\d)(?=(\\d{3})+$)', 'ig'), "$1,");
            return source.join(".");
        };
		//格式化日期
        function formatDate(dateTime) {
            var YYYY = dateTime.substring(0,4);
            var MM = dateTime.substring(4,6);
            var dd = dateTime.substring(6,8);
            var HH = dateTime.substring(8,10);
            var ss = dateTime.substring(10,12);
            var mm = dateTime.substring(12,14);
            var date = YYYY+"-"+MM+"-"+dd+" "+HH+":"+ss+":"+mm;
            return date;
        };
        function sure() {
            var storeNo = $('#orderNo').text(),
                orderNo = $('#order').text(),
                orderTime = $('#orderTime').text(),
                price = $('#price').text();
            var reg=/[\u4E00-\u9FA5]/g;
            var pri = price.replace(reg,'');
			var tqm=$('#tqmhidden').text();
			if(null==pricese){
                redirect("数据异常，不能提交！请联系商家！");
			}
            if(orderNo==null){
                redirect("数据异常，不能提交！请联系商家");
            }
            if(orderTime==null){
                redirect("数据异常，不能提交！请联系商家");
            }
            var ua = navigator.userAgent.toLowerCase();
            var isWeixin = ua.indexOf('micromessenger') != -1;
            var isAlipay = ua.indexOf('alipay') != -1;
            //var isUCBrowser = ua.indexOf('UCBrowser') != -1;
				var urlinfo = window.location.href; //获取当前页面的url
            if(isAlipay || urlinfo.indexOf("isAlipay=true") != -1){
                window.location.href = "../Family/ddmx.html?time=" + new Date();
            }else {
                window.location = "../common/isBrowser?orderNo=" + tqm + "&orderTime=" + orderTime +
                    "&storeNo=" + storeNo + "&price=" + pricese;
            }
        }
	</script>
</body>
</html>
