<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>信息确认</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="Cache" content="no-cache">
    <!--标准mui.css-->
    <link rel="stylesheet" href="../css/mui.min.css">
    <!--App自定义的css-->
    <link rel="stylesheet" type="text/css" href="../css/app.css"/>
    <style>
        body {
            background-image: url(../images/2016-11-25_143009.png); 
            background-size: 100% 100%; 
            background-attachment: fixed;
            max-width: 800px; 
            margin: 0 auto;
        }
        header img {
            width: 100%;
        }
        footer {
            position: fixed; 
            bottom: 10px; 
            width: 100%; 
            z-index: 99;
            max-width: 800px;
        }
        footer .fl {
            float: left;
            width: 70%;
        }
        footer .fr {
            float: right;
            width: 30%;
            text-align: right;
        }
        .main {
            width: 96%; 
            margin: 0 auto;
        }
        .mui-table h4, .mui-table h5, .mui-table .mui-h5, .mui-table .mui-h6,
        .mui-table p {
            margin-top: 0;
        }

        .mui-table h4 {
            line-height: 21px;
            font-weight: 500;
        }

        .mui-table .oa-icon {
            position: absolute;
            right: 0;
            bottom: 0;
        }

        .mui-table .oa-icon-star-filled {
            color: #f14e41;
        }
        .data-list {
            width: 100%; 
            margin-bottom: 15px;
        }
        .data-list h4 {
            color: #ff5722;
        }
        .data-list h5 {
            color: #FFFFFF;
        }
        #confirmBtn {
            width: 96%; 
            margin-left: 2%; 
            margin-top: 15px;
        }
    </style>
</head>
<body>

    <header>
        <img id="logo" src="logo/rjxx.jpg"/>
    </header>

    <section class="main">
        <div class="data-list">
            <h4 class="mui-ellipsis">订单号</h4>
            <h5 id="orderNo"></h5>
        </div>
        <div class="data-list">
            <h4 class="mui-ellipsis">门店编号</h4>
            <h5 id="storeNo"></h5>
        </div>
        <div class="data-list">
            <h4 class="mui-ellipsis">交易日期</h4>
            <h5 id="orderTime"></h5>
        </div>
        <div class="data-list">
            <h4 class="mui-ellipsis">订单金额</h4>
            <h5 id="price"></h5>
        </div>
    </section>

    <button id='confirmBtn' type="button" onclick="tk()" class="mui-btn mui-btn-primary mui-btn-block">确认</button>


    <footer>
        <div class="fl">泰易电子发票云服务平台</div>
        <div class="fr"><a href="../bangzhu.html">遇到问题?</a></div>
    </footer>

    <script src="../js/jquery.min.js"></script>
    <script src="../js/fpj.js"></script>

    <script type="text/javascript">
        function redirect(errorMsg){
            var myurl = "../QR/error.html?msg="+new Date+"="+errorMsg;
            window.location.assign(encodeURI(myurl));
        }
        $(function () {
            var thisURL = document.URL;
            var  getval =thisURL.split('?')[1];
            var ppdm= getval.split("=")[2];
            if(ppdm!="no"){
                $("#logo").attr("src", "../QR/logo/" + ppdm + ".png");
            }
            $.post(
                "../scan/scanConfirm",
                {},
                function (obj) {
                    if(obj.code=="1"){
                        var data = eval("(" + obj.data + ")");
                        //价格，多个则显示带逗号的多个，一个则显示一个
                        price =data.price;
                        //最后价格，如果是多个价格则算总和，如果只有一个只算一个
                        lastPrice=null;
                        lastSpsl = data.spsl;
                        lastSpmc=data.spmc;

                        if(price.indexOf(",")!=-1 &&lastSpsl.indexOf(",")!=-1 &&lastSpmc.indexOf(",")!=-1){
                            var pricesize=price.length-(price.replace(/,/g, "").length);
                            var spslsize=lastSpsl.length-(lastSpsl.replace(/,/g, "").length);
                            var spmcsize=lastSpmc.length-(lastSpmc.replace(/,/g, "").length);
                            //如果传过来的数据个数匹配
                            if(pricesize==spslsize && pricesize==spmcsize){
                                for(var i=0;i<pricesize+1;i++){
                                    lastPrice+=parseFloat(price.split(",")[i]);
                                }
                            }else {
                                redirect("传入数据有误,confirm.line[155]");
                            }
                        }else{
                            //如果传过来的数据，有的是多个有的是一个
                            if(lastSpsl.indexOf(",")!=-1 || lastSpmc.indexOf(",")!=-1 ||price.indexOf(",")!=-1 ){
                                redirect("传入数据有误,confirm.line[160]");
                            }
                            lastPrice = price;
                        }

                        orderNo = data.orderNo;
                        orderTime = data.orderTime;
                        storeNo = data.storeNo;
                        if(data.xgsdm!=null&&data.xgsdm!=""){
                            orderNo = data.xgsdm+"-"+data.orderNo;
                        }else {
                            orderNo = data.orderNo;
                        }
                        $('#orderNo').html(data.orderNo);
                        $('#orderTime').html(data.orderTime);
                        $('#storeNo').html(data.kpdmc+"("+data.storeNo+")");
                        $('#price').html(RetainedDecimalPlaces(lastPrice)+"元");
                    }else{
                        redirect(obj.msg)
                    }
                }
            )
        })
        function RetainedDecimalPlaces(num) {
            num = parseFloat(num).toFixed(2);
            var source = String(num).split(".");
            source[0] = source[0].replace(new RegExp('(\\d)(?=(\\d{3})+$)', 'ig'), "$1,");
            return source.join(".");
        };
        function tk() {
            var ua = navigator.userAgent.toLowerCase();
            var isWeixin = ua.indexOf('micromessenger') != -1;
            var isAlipay = ua.indexOf('alipay') != -1;
            if(isAlipay){
                var myurl = "../QR/input.html?param="+new Date()+"="+lastSpsl+"="+lastSpmc+"="+price;
                window.location.assign(encodeURI(myurl));
            }else if(isWeixin){
                window.location = "../common/isBrowser?orderNo=" + orderNo + "&orderTime=" + orderTime +
                    "&storeNo=" + storeNo + "&price=" + lastPrice;
            }else{
                redirect("请用微信或支付宝扫码");
            }
        }
    </script>
</body>
</html>