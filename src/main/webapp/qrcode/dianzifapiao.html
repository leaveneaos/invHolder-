<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>开票通</title>
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" type="text/css" href="css/common.css">
    <link rel="stylesheet" type="text/css" href="css/dianzifapiao.css">
    <script>
        window.onresize = function(){
            document.getElementsByTagName('html')[0].style.fontSize = (window.document.documentElement.getBoundingClientRect().width/750*100)+'px';
        }
        document.getElementsByTagName('html')[0].style.fontSize = (window.document.documentElement.getBoundingClientRect().width/750*100)+'px';

    </script>
    <style>
        html,body{
            background: white;
        }
        body{
            height: 100%;
            display: none;
        }
        header{
            margin-bottom: 4px;
            height: 68px;
            line-height: 68px;
        }
        header img {
            width: 234px;
            height: 26px;
            margin-left: 0 !important;
        }
        #advert{
            width: 100%;
            height: 3rem;display: block;
        }
        .money .btn{
            border-radius: 5px !important;
            margin-top: 20px;
        }
        .money{
            padding-top: 20px;
        }
        #sure{
            border-radius: 5px;
            border-radius: 5px;
            margin-top: 22px;
            height: 44px;
            line-height: 44px;
        }
    </style>
</head>
<body>
    <header>
        <img id="logo" src="logo/fujifilm.png">
    </header>
    <img id="advert" src="logo/fujifilm_advert.png">

    <div class="content">
        <ul id="tab">
            <li class="title" style=""><span>品名</span><span>税率</span><span>金额</span></li>
        </ul>
        <div class="money">
            <div class="txt">合计订单金额：<span id="hjje"></span></div>
            <div id="sure" class="btn"  onclick="sure()">确认</div>
        </div>
    </div>
    <div class="shadow2 hide">&nbsp;</div>
    <div class="shadow1 hide">&nbsp;</div>
    <footer><span>泰易开票通云服务平台</span><span>遇到问题？</span></footer>


<script src="../js/jquery.min.js"></script>
<script type="text/javascript">
    function redirect(errorMsg) {
        var myurl = "../QR/error.html?msg=" + new Date + "=" + errorMsg;
        window.location.assign(encodeURI(myurl));
    }
    $(function () {
        var thisURL = document.URL;
        var getval = thisURL.split('?')[1];
        ppdm = getval.split("=")[2];
        $.post(
            "../kptService/getShowMsg",
            {
                "ppdm":ppdm
            },
            function (obj) {
                if (obj.code == "1") {
                    var data = eval("(" + obj.data + ")");
                    var head = data.headcolor;
                    var body = data.bodycolor;
                    var button = data.buttoncolor;
                    if (head != "no" && body!="no" &&button!="no") {
                        $("body").css("background-color", body+"");
                        $("header").css("background-color", head+"");
                        $("#sure").css("background-color", button+"");
                    }
                } else {
                    redirect(obj.msg)
                }
            }
        )
        $("#logo").attr("src", "logo/" + ppdm + ".png");
        $("#advert").attr("src", "logo/" + ppdm + "_advert.png");
        $("body").css("display", "block");
        $.post(
            "../kptService/scanConfirm",
            {},
            function (obj) {
                if (obj.code == "1") {
                    var data = eval("(" + obj.data + ")");
                    //价格，多个则显示带逗号的多个，一个则显示一个
                    price = data.price;
                    //最后价格，如果是多个价格则算总和，如果只有一个只算一个
                    lastPrice = null;
                    lastSpsl = data.spsl;
                    lastSpmc = data.spmc;
                    orderTime = data.orderTime;
                    storeNo = data.storeNo;
                    gsmc = data.gsmc;
                    orderNo = data.orderNo;

                    var showMc = data.spmc;
                    var showSl = data.spsl;
                    var showJe = data.price;

                    if (price.indexOf(",") != -1 && lastSpsl.indexOf(",") != -1 && lastSpmc.indexOf(",") != -1) {
                        var pricesize = price.length - (price.replace(/,/g, "").length);
                        var spslsize = lastSpsl.length - (lastSpsl.replace(/,/g, "").length);
                        var spmcsize = lastSpmc.length - (lastSpmc.replace(/,/g, "").length);
                        //如果传过来的数据个数匹配
                        if (pricesize == spslsize && pricesize == spmcsize) {
                            for (var i = 0; i < pricesize + 1; i++) {
                                $("#tab").append("<li><span>" + showMc.split(",")[i] + "</span><span>" + showSl.split(",")[i] + "</span><span>" + showJe.split(",")[i] + "</span></li>");
                                lastPrice += parseFloat(price.split(",")[i]);
                            }
                        } else {
                            redirect("传入数据有误,confirm.line[155]");
                        }
                    } else {
                        //如果传过来的数据，有的是多个有的是一个
                        if (lastSpsl.indexOf(",") != -1 || lastSpmc.indexOf(",") != -1 || price.indexOf(",") != -1) {
                            redirect("传入数据有误,confirm.line[160]");
                        }
                        $("#tab").append("<li><span>" + showMc + "</span><span>" + showSl + "</span><span>" + showJe + "</span></li>");
                        lastPrice = price;
                    }
                    document.getElementById("hjje").innerText = lastPrice;
                } else {
                    redirect(obj.msg);
                }
            }
        )
    })

    function sure() {
            var ua = navigator.userAgent.toLowerCase();
            var isWeixin = ua.indexOf('micromessenger') != -1;
            if (isWeixin) {
                if (null == orderNo || orderTime == null || lastPrice == null) {
                    redirect("传入数据有误,请重新扫描！");
                }
                window.location = "../common/isBrowser?orderNo=" + orderNo + "&orderTime=" + orderTime +
                    "&storeNo=" + storeNo + "&price=" + lastPrice + "&gsdm=" + gsmc;
            } else {
                if (ppdm == null) {
                    redirect("跳转出现错误，请重新扫描！");
                }
                var myurl = "../qrcode/fptt.html?param=" + new Date() + "=" + ppdm;
                window.location.assign(encodeURI(myurl));
            }
    }
</script>
</body>
</html>
